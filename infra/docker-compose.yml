services:
  redpanda:
    image: redpandadata/redpanda:v23.3.12
    container_name: redpanda
    restart: unless-stopped
    command:
      - redpanda start
      - --overprovisioned
      - --smp 1
      - --memory 1G
      - --reserve-memory 0M
      - --node-id 0
      - --check=false
      - --kafka-addr PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
      - --advertise-kafka-addr PLAINTEXT://redpanda:29092,OUTSIDE://localhost:9092
    ports:
      - "9092:9092"  # Kafka external
      - "9644:9644"  # Admin API
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    networks:
      - streaming
    healthcheck:
      test: ["CMD", "rpk", "cluster", "info", "--brokers=redpanda:29092"]
      interval: 5s
      timeout: 3s
      retries: 10

  timescaledb:
    image: timescale/timescaledb:2.15.0-pg14
    container_name: timescaledb
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: anomalies
    ports:
      - "5432:5432"
    volumes:
      - ts-data:/var/lib/postgresql/data
    networks:
      - streaming
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d anomalies"]
      interval: 5s
      timeout: 3s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - streaming
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  backend:
    build: ../backend
    container_name: backend
    restart: unless-stopped
    depends_on:
      redpanda:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: ${DATABASE_URL}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_AUTO_OFFSET_RESET: ${KAFKA_AUTO_OFFSET_RESET}
      PROCESSOR_CONSUMER_GROUP: ${PROCESSOR_CONSUMER_GROUP}
      REDIS_URL: ${REDIS_URL}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      PRICE_TOPIC: prices
      NEWS_TOPIC: news
      ALERTS_TOPIC: alerts
    ports:
      - "8000:8000"
    networks:
      - streaming
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()\""]
      interval: 5s
      timeout: 3s
      retries: 10

  processor:
    build:
      context: ../processor
      args:
        SENTIMENT_LIGHT_RUNTIME: ${SENTIMENT_LIGHT_RUNTIME:-false}
    container_name: processor
    restart: unless-stopped
    depends_on:
      redpanda:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: ${DATABASE_URL}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      REDIS_URL: ${REDIS_URL}
      BINANCE_STREAM: ${BINANCE_STREAM}
      SYMBOLS: ${SYMBOLS}
      NEWS_RSS: ${NEWS_RSS}
      ALERT_THRESHOLD_1M: ${ALERT_THRESHOLD_1M}
      ALERT_THRESHOLD_5M: ${ALERT_THRESHOLD_5M}
      ALERT_THRESHOLD_15M: ${ALERT_THRESHOLD_15M}
      LLM_PROVIDER: ${LLM_PROVIDER}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      PRICE_TOPIC: prices
      NEWS_TOPIC: news
      ALERTS_TOPIC: alerts
      SUMMARIES_TOPIC: summaries
      PROCESSOR_METRICS_HOST: ${PROCESSOR_METRICS_HOST}
      PROCESSOR_METRICS_PORT: ${PROCESSOR_METRICS_PORT}
      PYTHONPATH: /app
    networks:
      - streaming
    working_dir: /app
    command: python -m src.app

  summary-sidecar:
    build:
      context: ../processor
      args:
        SENTIMENT_LIGHT_RUNTIME: ${SENTIMENT_LIGHT_RUNTIME:-false}
    container_name: summary-sidecar
    restart: unless-stopped
    depends_on:
      redpanda:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    environment:
      DATABASE_URL: ${DATABASE_URL}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      LLM_PROVIDER: ${LLM_PROVIDER}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      GOOGLE_MODEL: ${GOOGLE_MODEL}
      OPENAI_MODEL: ${OPENAI_MODEL}
      ALERTS_TOPIC: alerts
      SUMMARIES_TOPIC: summaries
      SUMMARY_METRICS_HOST: ${SUMMARY_METRICS_HOST}
      SUMMARY_METRICS_PORT: ${SUMMARY_METRICS_PORT}
      PYTHONPATH: /app
    working_dir: /app
    command: python -m src.services.summary_sidecar
    networks:
      - streaming

  sentiment-sidecar:
    build:
      context: ../processor
      args:
        SENTIMENT_LIGHT_RUNTIME: ${SENTIMENT_LIGHT_RUNTIME:-false}
    container_name: sentiment-sidecar
    restart: unless-stopped
    depends_on:
      redpanda:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    environment:
      DATABASE_URL: ${DATABASE_URL}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      SENTIMENT_PROVIDER: ${SENTIMENT_PROVIDER:-stub}
      SENTIMENT_MODEL_PATH: ${SENTIMENT_MODEL_PATH:-/models/finbert}
      SENTIMENT_BATCH_SIZE: ${SENTIMENT_BATCH_SIZE:-16}
      SENTIMENT_MAX_LATENCY_MS: ${SENTIMENT_MAX_LATENCY_MS:-}
      SENTIMENT_SIDECAR_GROUP: ${SENTIMENT_SIDECAR_GROUP:-sentiment-sidecar}
      SENTIMENT_LIGHT_RUNTIME: ${SENTIMENT_LIGHT_RUNTIME:-false}
      SENTIMENT_METRICS_HOST: ${SENTIMENT_METRICS_HOST:-0.0.0.0}
      SENTIMENT_METRICS_PORT: ${SENTIMENT_METRICS_PORT:-9101}
      NEWS_TOPIC: ${NEWS_TOPIC:-news}
      NEWS_ENRICHED_TOPIC: ${NEWS_ENRICHED_TOPIC:-news-enriched}
      NEWS_DLQ_TOPIC: ${NEWS_DLQ_TOPIC:-news-deadletter}
      PYTHONPATH: /app
    volumes:
      - ../models/finbert:/models/finbert
    working_dir: /app
    command: python -m src.services.sentiment_sidecar
    networks:
      - streaming

  frontend:
    build: ../frontend
    container_name: frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    environment:
      NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE}
      NEXT_PUBLIC_WS_BASE: ${NEXT_PUBLIC_WS_BASE}
    ports:
      - "3000:3000"
    networks:
      - streaming

volumes:
  redpanda-data:
  ts-data:

networks:
  streaming:
    driver: bridge
